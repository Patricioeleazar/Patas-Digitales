<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Patitas Digital — DNI Mascota</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0b0f1a;
      --title: #111827;
      --muted: #64748b;
      --accent: #2563eb;
      --accent-2: #1d4ed8;
      --border: #e2e8f0;
      --shadow: 0 6px 24px rgba(0, 0, 0, 0.06);
      --radius: 16px;
      --space-1: 4px; --space-2: 8px; --space-3: 12px; --space-4: 16px; --space-5: 24px; --space-6: 32px;
    }
    .dark {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f1f5f9;
      --title: #f8fafc;
      --muted: #94a3b8;
      --accent: #3b82f6;
      --accent-2: #2563eb;
      --border: #334155;
      --shadow: 0 6px 24px rgba(0,0,0,.3);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body { font-family: 'Poppins', system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }

    .container { max-width: 960px; margin: 0 auto; padding: var(--space-5); }

    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-6); }
    .brand { font-weight: 600; font-size: 1.25rem; letter-spacing: .5px; color: var(--title); text-transform: uppercase; }

    .toggle { width: 48px; height: 26px; border-radius: 26px; background: var(--border); position: relative; cursor: pointer; transition: .15s ease; }
    .toggle::after { content: ""; position: absolute; inset: 3px auto 3px 3px; width: 20px; border-radius: 50%; background: var(--card); transition: .15s ease; }
    .toggle.active { background: var(--accent); }
    .toggle.active::after { inset: 3px 3px 3px auto; }

    .content { display: grid; gap: var(--space-5); }
    @media (min-width: 840px) { .content { grid-template-columns: 1fr 1fr; } }

    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: var(--space-5); border: 1px solid var(--border); }
    .title { color: var(--title); font-weight: 600; font-size: 1.25rem; margin-bottom: var(--space-2); text-transform: uppercase; }
    .subtitle { color: var(--muted); text-transform: uppercase; margin-bottom: var(--space-5); font-size: .95rem; }

    .field { margin-bottom: var(--space-4); }
    label { display:block; font-size:.85rem; margin-bottom: var(--space-2); color: var(--text); text-transform: uppercase; }
    input, textarea { width: 100%; padding: var(--space-3); border:1px solid var(--border); border-radius: 12px; font: inherit; background: var(--card); color: var(--text); }
    input:focus, textarea:focus { outline: none; box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 25%, transparent); border-color: var(--accent); }
    .hint { font-size: .8rem; color: var(--muted); margin-top: var(--space-1); text-transform: uppercase; }

    .file-box { border:1px dashed var(--border); border-radius: 12px; padding: var(--space-4); text-align:center; cursor:pointer; }
    #preview { margin-top: var(--space-3); display:none; width: 140px; height:140px; border-radius:50%; object-fit:cover; border:1px solid var(--border); }

    .actions { display:flex; gap: var(--space-3); flex-wrap:wrap; margin-top: var(--space-5); }
    .btn { border: none; border-radius: 12px; padding: var(--space-3) var(--space-5); cursor: pointer; font-weight: 500; min-height:44px; text-transform: uppercase; }
    .btn.primary { background: var(--accent); color: #fff; }
    .btn.primary:hover { background: var(--accent-2); }
    .btn.ghost { background: transparent; color: var(--accent); border:1px solid var(--accent); }
    .btn.ghost:hover { background: color-mix(in srgb, var(--accent) 10%, transparent); }

    .preview-title { color: var(--title); font-weight: 600; font-size: 1.1rem; margin-bottom: var(--space-3); text-transform: uppercase; }
    canvas { width: 100%; max-width: 640px; height: auto; border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid var(--border); }

    .share { margin-top: var(--space-5); background: color-mix(in srgb, var(--border) 40%, transparent); border-radius: var(--radius); padding: var(--space-4); word-break: break-all; }
    .share label { color: var(--title); margin-bottom: var(--space-2); }
    .share a { color: var(--accent); text-decoration: none; }
    .share a:hover { text-decoration: underline; }

    @media print {
      header, .form, .share, .actions { display:none !important; }
      body { background: #fff; }
      .card { border: 0; box-shadow: none; padding: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">Patitas Digital</div>
      <div id="themeToggle" class="toggle" title="Cambiar tema"></div>
    </header>

    <div id="app" class="content">
      <div class="card form">
        <div class="title">Registrar Mascota</div>
        <div class="subtitle">Completá los datos y generá el DNI</div>

        <div class="field">
          <label for="pet">Nombre de la mascota *</label>
          <input id="pet" placeholder="Firulais" />
        </div>
        <div class="field">
          <label for="breed">Raza</label>
          <input id="breed" placeholder="Labrador" />
        </div>
        <div class="field">
          <label for="color">Color</label>
          <input id="color" placeholder="Marrón" />
        </div>
        <div class="field">
          <label for="owner">Nombre del dueño *</label>
          <input id="owner" placeholder="Juan Pérez" />
        </div>
        <div class="field">
          <label for="phone">Teléfono *</label>
          <input id="phone" placeholder="381 123-4567" />
          <div class="hint">Formato simple: código de área + número</div>
        </div>
        <div class="field">
          <label for="obs">Observaciones / alergias</label>
          <textarea id="obs" maxlength="120" rows="3" placeholder="Max 120 caracteres"></textarea>
          <div class="hint"><span id="count">0</span>/120</div>
        </div>

        <div class="field">
          <label for="photo">Foto de la mascota (opcional)</label>
          <label class="file-box" for="photo">Seleccionar imagen</label>
          <input id="photo" type="file" accept="image/*" hidden />
          <img id="preview" alt="Previsualización" />
        </div>

        <div class="actions">
          <button id="generate" class="btn primary">Generar DNI</button>
        </div>
      </div>

      <div class="card">
        <div class="preview-title">Vista previa del DNI</div>
        <canvas id="card" width="640" height="400"></canvas>
        <div class="actions">
          <button id="download" class="btn primary">Descargar PNG</button>
          <button id="print" class="btn ghost">Imprimir</button>
        </div>
        <div class="share">
          <label>Enlace para compartir</label>
          <div><a id="shareLink" href="#" target="_blank"></a></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Estado ---
    const state = {
      theme: localStorage.getItem('theme') || 'system',
      photo: null, // Image element
      data: null,  // Últimos datos renderizados (para re-render con tema)
    };

    const el = (id) => document.getElementById(id);

    // --- Tema ---
    function applyTheme() {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const dark = state.theme === 'dark' || (state.theme === 'system' && prefersDark);
      document.documentElement.classList.toggle('dark', dark);
      el('themeToggle').classList.toggle('active', dark);
      // Re-render si hay datos
      if (state.data) renderCard(state.data);
    }

    function toggleTheme() {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDarkNow = document.documentElement.classList.contains('dark');
      const next = isDarkNow ? 'light' : 'dark';
      state.theme = next;
      localStorage.setItem('theme', next);
      applyTheme();
    }

    // --- Utilidad: QR a dataURL usando canvas interno ---
    function qrToDataURL(text, size = 100) {
      return new Promise((resolve) => {
        const holder = document.createElement('div');
        holder.style.position = 'fixed';
        holder.style.left = '-9999px';
        document.body.appendChild(holder);
        new QRCode(holder, { text, width: size, height: size, correctLevel: QRCode.CorrectLevel.H });
        // Esperar al próximo frame para asegurar que el QR esté listo
        requestAnimationFrame(() => {
          const cnv = holder.querySelector('canvas');
          let url;
          if (cnv) {
            url = cnv.toDataURL('image/png');
          } else {
            const img = holder.querySelector('img');
            url = img ? img.src : '';
          }
          document.body.removeChild(holder);
          resolve(url);
        });
      });
    }

    // --- Dibujo de la tarjeta en canvas ---
    async function renderCard(data) {
      state.data = data; // guardar para re-renders
      const c = el('card');
      const ctx = c.getContext('2d');
      const dark = document.documentElement.classList.contains('dark');

      // Lienzo limpio
      ctx.clearRect(0, 0, c.width, c.height);

      // Fondo tarjeta
      ctx.fillStyle = dark ? '#1e293b' : '#ffffff';
      ctx.fillRect(0, 0, c.width, c.height);

      // Encabezado
      ctx.fillStyle = '#2563eb';
      ctx.fillRect(0, 0, c.width, 60);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 20px Poppins, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('PATITAS DIGITAL — DNI MASCOTA', c.width / 2, 38);

      // Foto circular
      const photoSize = 120, photoX = 50, photoY = 100;
      ctx.save();
      ctx.beginPath();
      ctx.arc(photoX + photoSize/2, photoY + photoSize/2, photoSize/2, 0, Math.PI*2);
      ctx.closePath();
      ctx.clip();
      if (state.photo) {
        ctx.drawImage(state.photo, photoX, photoY, photoSize, photoSize);
      } else {
        ctx.fillStyle = dark ? '#334155' : '#e2e8f0';
        ctx.fillRect(photoX, photoY, photoSize, photoSize);
        ctx.fillStyle = dark ? '#94a3b8' : '#94a3b8';
        ctx.font = '50px Poppins, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('🐾', photoX + photoSize/2, photoY + photoSize/2 + 16);
      }
      ctx.restore();
      // Borde foto
      ctx.strokeStyle = dark ? '#334155' : '#e2e8f0';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.arc(photoX + photoSize/2, photoY + photoSize/2, photoSize/2, 0, Math.PI*2);
      ctx.stroke();

      // Textos
      ctx.fillStyle = dark ? '#f8fafc' : '#111827';
      ctx.textAlign = 'left';
      ctx.font = 'bold 28px Poppins, sans-serif';
      ctx.fillText(data.pet.toUpperCase(), 220, 140);

      ctx.font = '16px Poppins, sans-serif';
      ctx.fillStyle = dark ? '#cbd5e1' : '#64748b';
      const bc = [data.breed, data.color].filter(Boolean).join(' • ');
      if (bc) ctx.fillText(bc.toUpperCase(), 220, 170);

      ctx.fillStyle = dark ? '#e2e8f0' : '#0b0f1a';
      ctx.font = '15px Poppins, sans-serif';
      ctx.fillText(`DUEÑO: ${data.owner.toUpperCase()}`, 220, 210);
      ctx.fillText(`TELÉFONO: ${data.phone.toUpperCase()}`, 220, 240);

      if (data.obs) {
        ctx.font = '14px Poppins, sans-serif';
        ctx.fillStyle = dark ? '#94a3b8' : '#64748b';
        // Ajuste simple a una línea: recortar si es muy largo
        const txt = `OBS: ${data.obs.toUpperCase()}`;
        ctx.fillText(txt.length > 56 ? txt.slice(0, 56) + '…' : txt, 220, 270);
      }

      // Línea divisoria
      ctx.strokeStyle = dark ? '#334155' : '#e2e8f0';
      ctx.beginPath(); ctx.moveTo(0, 340); ctx.lineTo(c.width, 340); ctx.stroke();

      // Generar URL y QR
      const qrUrl = buildViewUrl(data);
      const qrDataURL = await qrToDataURL(qrUrl, 110);
      const img = new Image();
      await new Promise((res) => { img.onload = res; img.src = qrDataURL; });
      const qrX = c.width - 140, qrY = 95, qrSize = 110;
      ctx.drawImage(img, qrX, qrY, qrSize, qrSize);

      ctx.fillStyle = dark ? '#94a3b8' : '#64748b';
      ctx.font = '12px Poppins, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('ESCANEÁ PARA VER FICHA', qrX + qrSize/2, qrY + qrSize + 20);

      // Link para compartir
      const link = el('shareLink');
      if (link) { link.href = qrUrl; link.textContent = qrUrl; }
    }

    // --- URL de modo lector (?view=1...) ---
    function buildViewUrl(data) {
      const base = window.location.origin + window.location.pathname;
      const p = new URLSearchParams();
      p.set('view', '1');
      p.set('n', data.pet);
      p.set('dn', data.owner);
      p.set('tel', data.phone);
      if (data.breed) p.set('rz', data.breed);
      if (data.color) p.set('co', data.color);
      if (data.obs) p.set('obs', data.obs);
      return `${base}?${p.toString()}`;
    }

    // --- Descarga/Impresión ---
    function downloadPNG(name) {
      const a = document.createElement('a');
      a.download = `dni_mascota_${name.replace(/\\s+/g, '_')}.png`;
      a.href = el('card').toDataURL('image/png');
      a.click();
    }

    // --- Modo lector (URL) ---
    function parseViewParams() {
      const u = new URLSearchParams(location.search);
      if (u.get('view') !== '1') return null;
      return {
        pet: u.get('n') || '',
        breed: u.get('rz') || '',
        color: u.get('co') || '',
        owner: u.get('dn') || '',
        phone: u.get('tel') || '',
        obs: u.get('obs') || '',
      };
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      // Contador obs
      el('obs').addEventListener('input', (e) => { el('count').textContent = e.target.value.length; });

      // Foto
      el('photo').addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) { state.photo = null; el('preview').style.display = 'none'; return; }
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => { state.photo = img; el('preview').src = img.src; el('preview').style.display = 'block'; };
          img.src = reader.result;
        };
        reader.readAsDataURL(f);
      });

      // Generar
      el('generate').addEventListener('click', () => {
        const data = {
          pet: el('pet').value.trim(),
          breed: el('breed').value.trim(),
          color: el('color').value.trim(),
          owner: el('owner').value.trim(),
          phone: el('phone').value.trim(),
          obs: el('obs').value.trim(),
        };
        if (!data.pet || !data.owner || !data.phone) {
          alert('Completá los campos obligatorios: mascota, dueño y teléfono.');
          return;
        }
        renderCard(data);
      });

      // Acciones
      el('download').addEventListener('click', () => {
        const name = state.data?.pet || 'mascota';
        downloadPNG(name);
      });
      el('print').addEventListener('click', () => window.print());

      // Tema
      el('themeToggle').addEventListener('click', toggleTheme);
      applyTheme();

      // ¿Modo lector?
      const viewData = parseViewParams();
      if (viewData) {
        // Solo tarjeta: simplificar layout
        document.querySelector('.form').style.display = 'none';
        renderCard(viewData);
      } else {
        // Render inicial vacío (placeholder)
        renderCard({ pet: 'TU MASCOTA', breed: '—', color: '', owner: 'DUEÑO/A', phone: '—', obs: '' });
      }
    });
  </script>
</body>
</html>
